<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Noteworthy - Configuration</title>
  <link rel="stylesheet" href="/css/config.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>The Noteworthy Widget</h1>
      <p>Bring your notes to OBS</p>
    </header>

    <div class="cards-grid">
      <!-- Widget Preview -->
      <div class="card full-width">
        <h2>Live Preview</h2>
        <div class="preview-controls">
          <div class="size-control">
            <label>Width</label>
            <input type="number" id="canvas-width" value="450" min="100" max="1920" step="10">
            <span>px</span>
          </div>
          <div class="size-control">
            <label>Height</label>
            <input type="number" id="canvas-height" value="150" min="50" max="1080" step="10">
            <span>px</span>
          </div>
          <button class="btn btn-secondary btn-small" onclick="resetCanvasSize()">Reset</button>
        </div>
        <div class="preview-container">
          <iframe id="widget-preview" src="/widget?preview=true"></iframe>
        </div>
      </div>

      <!-- Widget URL -->
      <div class="card">
        <h2>Widget URL</h2>
        <p style="color: rgba(255,255,255,0.6); margin-bottom: 16px;">
          Add this URL as a Browser Source in OBS
        </p>

        <div class="url-box">
          <input type="text" id="widget-url" readonly>
          <button class="btn btn-secondary" onclick="copyUrl()">Copy</button>
        </div>

        <div class="instructions" style="margin-top: 20px;">
          <h3 style="margin-bottom: 12px;">OBS Setup Instructions</h3>
          <ol>
            <li>In OBS, click <strong>+</strong> under Sources</li>
            <li>Select <strong>Browser</strong></li>
            <li>Paste the widget URL</li>
            <li>Set width to <strong id="obs-width">450</strong> and height to <strong id="obs-height">150</strong></li>
            <li>Check "Refresh browser when scene becomes active" (optional)</li>
          </ol>
        </div>
      </div>

      <!-- Customization -->
      <div class="card">
        <h2>Theme</h2>
        <p style="color: rgba(255,255,255,0.6); margin-bottom: 16px;">
          Choose a visual style for your widget
        </p>

        <div class="customization-grid">
          <div class="theme-option active" data-theme="">
            <div class="theme-preview glass"></div>
            <span>Glass (Default)</span>
          </div>
          <div class="theme-option" data-theme="dark">
            <div class="theme-preview dark"></div>
            <span>Dark</span>
          </div>
          <div class="theme-option" data-theme="light">
            <div class="theme-preview light"></div>
            <span>Light</span>
          </div>
          <div class="theme-option" data-theme="vaporwave">
            <div class="theme-preview vaporwave"></div>
            <span>Vaporwave</span>
          </div>
          <div class="theme-option" data-theme="retro">
            <div class="theme-preview retro"></div>
            <span>Retro</span>
          </div>
          <div class="theme-option" data-theme="custom">
            <div class="theme-preview custom" id="custom-theme-preview"></div>
            <span>Custom</span>
          </div>
        </div>

        <!-- Custom Color Picker -->
        <div id="custom-color-section" class="custom-color-section">
          <div class="color-picker-row">
            <label>Background Color</label>
            <div class="color-input-group">
              <input type="color" id="bg-color" value="#1a1a2e">
              <input type="text" id="bg-color-text" value="#1a1a2e" maxlength="7">
            </div>
          </div>
          <div class="color-picker-row">
            <label>Text Color</label>
            <div class="color-input-group">
              <input type="color" id="text-color" value="#ffffff">
              <input type="text" id="text-color-text" value="#ffffff" maxlength="7">
            </div>
          </div>
          <div class="color-picker-row">
            <label>Accent Color</label>
            <div class="color-input-group">
              <input type="color" id="accent-color" value="#1DB954">
              <input type="text" id="accent-color-text" value="#1DB954" maxlength="7">
            </div>
          </div>
        </div>
      </div>

      <!-- Presets -->
      <div class="card">
        <h2>Presets</h2>
        <p style="color: rgba(255,255,255,0.6); margin-bottom: 16px;">
          Save and load your configuration
        </p>

        <!-- Save Current Config -->
        <div class="preset-save-section">
          <div class="preset-input-row">
            <input type="text" id="preset-name" placeholder="Preset name..." maxlength="30">
            <button class="btn btn-primary" onclick="savePreset()">Save</button>
          </div>
        </div>

        <!-- Saved Presets List -->
        <div class="presets-list">
          <h3>Saved Presets</h3>
          <div id="presets-container">
            <div class="no-presets-message">No presets saved yet</div>
          </div>
        </div>
      </div>

      <!-- Custom Themes -->
      <div class="card">
        <h2>Custom Themes</h2>
        <p style="color: rgba(255,255,255,0.6); margin-bottom: 16px;">
          Upload your own HTML theme templates
        </p>

        <!-- Upload Form -->
        <div class="upload-section">
          <form id="theme-upload-form" enctype="multipart/form-data">
            <div class="file-input-wrapper">
              <input type="file" id="theme-file" accept=".html">
              <label for="theme-file" class="btn btn-secondary">Choose File</label>
              <span id="selected-file-name">No file selected</span>
            </div>
            <button type="submit" class="btn btn-primary" id="upload-btn" disabled>Upload Theme</button>
          </form>
        </div>

        <!-- Uploaded Themes List -->
        <div class="custom-themes-list">
          <h3>Uploaded Themes</h3>
          <div id="themes-container">
            <div class="no-themes-message">No custom themes uploaded yet</div>
          </div>
        </div>

        <!-- Theme Template Info -->
        <div class="theme-template-info">
          <h3>Creating Custom Themes</h3>
          <p>Custom themes are HTML files with embedded CSS. Download the template to get started:</p>
          <a href="/api/themes/template/download" class="btn btn-secondary" style="margin-top: 12px;">Download Template</a>
          <details style="margin-top: 12px;">
            <summary style="cursor: pointer; color: var(--pixel-accent);">Required Elements</summary>
            <ul>
              <li><code>id="widget-container"</code></li>
              <li><code>id="idle-state"</code></li>
              <li><code>id="track-content"</code></li>
              <li><code>id="album-art"</code></li>
              <li><code>id="track-title"</code></li>
              <li><code>id="track-artist"</code></li>
              <li><code>id="progress-bar"</code></li>
              <li><code>id="current-time"</code></li>
              <li><code>id="total-time"</code></li>
              <li><code>id="visualizer"</code></li>
            </ul>
          </details>
        </div>
      </div>

      <!-- Info Card -->
      <div class="card full-width">
        <h2>Supported Music Apps</h2>
        <p style="color: rgba(255,255,255,0.8); margin-bottom: 16px;">
          This widget automatically detects music from <strong>Windows Media Session</strong>, which works with:
        </p>
        <ul style="color: rgba(255,255,255,0.7); margin-left: 20px; line-height: 1.8; column-count: 2; column-gap: 40px;">
          <li>Spotify (Desktop App)</li>
          <li>Apple Music (Windows App)</li>
          <li>iTunes</li>
          <li>Windows Media Player</li>
          <li>VLC</li>
          <li>Most other media players</li>
        </ul>
        <p style="color: rgba(255,255,255,0.6); margin-top: 16px; font-size: 0.9rem;">
          Just play music in any of these apps and the widget will automatically display it!
        </p>
      </div>
    </div>
  </div>

  <div id="notification" class="notification">Copied to clipboard!</div>

  <script>
    // State
    let currentTheme = '';
    let customColors = {
      bg: '#1a1a2e',
      text: '#ffffff',
      accent: '#1DB954'
    };
    let canvasSize = { width: 450, height: 150 };

    // Elements
    const themeOptions = document.querySelectorAll('.theme-option');
    const widgetUrlInput = document.getElementById('widget-url');
    const widgetPreview = document.getElementById('widget-preview');
    const customColorSection = document.getElementById('custom-color-section');
    const customThemePreview = document.getElementById('custom-theme-preview');
    const canvasWidthInput = document.getElementById('canvas-width');
    const canvasHeightInput = document.getElementById('canvas-height');
    const obsWidthDisplay = document.getElementById('obs-width');
    const obsHeightDisplay = document.getElementById('obs-height');

    // Color inputs
    const bgColorInput = document.getElementById('bg-color');
    const bgColorText = document.getElementById('bg-color-text');
    const textColorInput = document.getElementById('text-color');
    const textColorText = document.getElementById('text-color-text');
    const accentColorInput = document.getElementById('accent-color');
    const accentColorText = document.getElementById('accent-color-text');

    // Initialize
    function init() {
      updateCustomPreview();
      updateWidgetUrl();
      updateCanvasSize();
    }

    // Canvas size handling
    function updateCanvasSize() {
      widgetPreview.style.width = canvasSize.width + 'px';
      widgetPreview.style.height = canvasSize.height + 'px';
      obsWidthDisplay.textContent = canvasSize.width;
      obsHeightDisplay.textContent = canvasSize.height;
    }

    function resetCanvasSize() {
      canvasSize = { width: 450, height: 150 };
      canvasWidthInput.value = 450;
      canvasHeightInput.value = 150;
      updateCanvasSize();
    }

    canvasWidthInput.addEventListener('input', () => {
      const val = parseInt(canvasWidthInput.value) || 450;
      canvasSize.width = Math.max(100, Math.min(1920, val));
      updateCanvasSize();
    });

    canvasHeightInput.addEventListener('input', () => {
      const val = parseInt(canvasHeightInput.value) || 150;
      canvasSize.height = Math.max(50, Math.min(1080, val));
      updateCanvasSize();
    });

    // Theme selection
    themeOptions.forEach(option => {
      option.addEventListener('click', () => {
        themeOptions.forEach(t => t.classList.remove('active'));
        option.classList.add('active');
        currentTheme = option.dataset.theme;

        // Show/hide custom color section
        if (currentTheme === 'custom') {
          customColorSection.classList.add('visible');
        } else {
          customColorSection.classList.remove('visible');
        }

        updateWidgetUrl();
      });
    });

    // Color picker event listeners
    function syncColorInputs(colorInput, textInput, colorKey) {
      colorInput.addEventListener('input', () => {
        textInput.value = colorInput.value;
        customColors[colorKey] = colorInput.value;
        updateCustomPreview();
        if (currentTheme === 'custom') updateWidgetUrl();
      });

      textInput.addEventListener('input', () => {
        const value = textInput.value;
        if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
          colorInput.value = value;
          customColors[colorKey] = value;
          updateCustomPreview();
          if (currentTheme === 'custom') updateWidgetUrl();
        }
      });

      textInput.addEventListener('blur', () => {
        // Ensure valid format on blur
        if (!/^#[0-9A-Fa-f]{6}$/.test(textInput.value)) {
          textInput.value = colorInput.value;
        }
      });
    }

    syncColorInputs(bgColorInput, bgColorText, 'bg');
    syncColorInputs(textColorInput, textColorText, 'text');
    syncColorInputs(accentColorInput, accentColorText, 'accent');

    // Update custom theme preview swatch
    function updateCustomPreview() {
      customThemePreview.style.background = `linear-gradient(135deg, ${customColors.bg}, ${customColors.accent})`;
    }

    // Update widget URL
    function updateWidgetUrl() {
      const baseUrl = `${window.location.origin}/widget`;
      const params = new URLSearchParams();
      const previewParams = new URLSearchParams();

      if (currentTheme === 'custom') {
        params.set('bg', customColors.bg.replace('#', ''));
        params.set('text', customColors.text.replace('#', ''));
        params.set('accent', customColors.accent.replace('#', ''));
        previewParams.set('bg', customColors.bg.replace('#', ''));
        previewParams.set('text', customColors.text.replace('#', ''));
        previewParams.set('accent', customColors.accent.replace('#', ''));
      } else if (currentTheme) {
        params.set('theme', currentTheme);
        previewParams.set('theme', currentTheme);
      }
      previewParams.set('preview', 'true');

      const url = params.toString() ? `${baseUrl}?${params}` : baseUrl;
      widgetUrlInput.value = url;

      // Update preview (always has preview=true)
      widgetPreview.src = `${baseUrl}?${previewParams}`;
    }

    // Show notification
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.background = type === 'error' ? '#ff6b6b' : 'var(--pixel-accent)';
      notification.classList.add('visible');
      setTimeout(() => notification.classList.remove('visible'), 3000);
    }

    // Copy URL
    function copyUrl() {
      widgetUrlInput.select();
      document.execCommand('copy');
      showNotification('Copied to clipboard!');
    }

    // ========== Custom Theme Upload ==========

    const themeFileInput = document.getElementById('theme-file');
    const selectedFileName = document.getElementById('selected-file-name');
    const uploadBtn = document.getElementById('upload-btn');
    const uploadForm = document.getElementById('theme-upload-form');
    const themesContainer = document.getElementById('themes-container');

    // File selection handler
    themeFileInput.addEventListener('change', () => {
      if (themeFileInput.files.length > 0) {
        selectedFileName.textContent = themeFileInput.files[0].name;
        uploadBtn.disabled = false;
      } else {
        selectedFileName.textContent = 'No file selected';
        uploadBtn.disabled = true;
      }
    });

    // Upload handler
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData();
      formData.append('theme', themeFileInput.files[0]);

      uploadBtn.textContent = 'Uploading...';
      uploadBtn.disabled = true;

      try {
        const response = await fetch('/api/themes/upload', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          showNotification('Theme uploaded successfully!');
          loadCustomThemes();
          themeFileInput.value = '';
          selectedFileName.textContent = 'No file selected';
        } else {
          showNotification(result.error || 'Upload failed', 'error');
        }
      } catch (error) {
        showNotification('Upload failed: ' + error.message, 'error');
      }

      uploadBtn.textContent = 'Upload Theme';
      uploadBtn.disabled = true;
    });

    // Load custom themes list
    async function loadCustomThemes() {
      try {
        const response = await fetch('/api/themes');
        const themes = await response.json();

        if (themes.custom.length === 0) {
          themesContainer.innerHTML = '<div class="no-themes-message">No custom themes uploaded yet</div>';
          return;
        }

        themesContainer.innerHTML = themes.custom.map(theme => `
          <div class="custom-theme-item" data-theme-id="${theme.id}">
            <div class="custom-theme-info">
              <div class="custom-theme-name">${theme.name}</div>
              ${theme.author ? `<div class="custom-theme-author">by ${theme.author}</div>` : ''}
            </div>
            <div class="custom-theme-actions">
              <button class="btn btn-small btn-secondary" onclick="previewCustomTheme('${theme.id}')">Preview</button>
              <button class="btn btn-small btn-primary" onclick="selectCustomTheme('${theme.id}', '${theme.name}')">Use</button>
              <button class="btn btn-small btn-danger" onclick="deleteCustomTheme('${theme.id}')">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        themesContainer.innerHTML = '<div class="no-themes-message">Error loading themes</div>';
      }
    }

    // Preview custom theme
    function previewCustomTheme(themeId) {
      widgetPreview.src = `/widget?customTheme=${themeId}&preview=true`;
    }

    // Select custom theme
    function selectCustomTheme(themeId, themeName) {
      currentTheme = `custom:${themeId}`;
      themeOptions.forEach(t => t.classList.remove('active'));
      customColorSection.classList.remove('visible');
      updateWidgetUrl();
      showNotification(`Theme "${themeName}" selected`);
    }

    // Delete custom theme
    async function deleteCustomTheme(themeId) {
      if (!confirm(`Delete theme "${themeId}"?`)) return;

      try {
        const response = await fetch(`/api/themes/${themeId}`, { method: 'DELETE' });
        const result = await response.json();

        if (result.success) {
          showNotification('Theme deleted');
          loadCustomThemes();
          // Reset to default if deleted theme was selected
          if (currentTheme === `custom:${themeId}`) {
            currentTheme = '';
            themeOptions[0].classList.add('active');
            updateWidgetUrl();
          }
        } else {
          showNotification(result.error || 'Delete failed', 'error');
        }
      } catch (error) {
        showNotification('Delete failed: ' + error.message, 'error');
      }
    }

    // Update updateWidgetUrl to handle custom themes
    const originalUpdateWidgetUrl = updateWidgetUrl;
    updateWidgetUrl = function() {
      const baseUrl = `${window.location.origin}/widget`;
      const params = new URLSearchParams();
      const previewParams = new URLSearchParams();

      if (currentTheme.startsWith('custom:')) {
        const themeId = currentTheme.replace('custom:', '');
        params.set('customTheme', themeId);
        previewParams.set('customTheme', themeId);
      } else if (currentTheme === 'custom') {
        params.set('bg', customColors.bg.replace('#', ''));
        params.set('text', customColors.text.replace('#', ''));
        params.set('accent', customColors.accent.replace('#', ''));
        previewParams.set('bg', customColors.bg.replace('#', ''));
        previewParams.set('text', customColors.text.replace('#', ''));
        previewParams.set('accent', customColors.accent.replace('#', ''));
      } else if (currentTheme) {
        params.set('theme', currentTheme);
        previewParams.set('theme', currentTheme);
      }
      previewParams.set('preview', 'true');

      const url = params.toString() ? `${baseUrl}?${params}` : baseUrl;
      widgetUrlInput.value = url;
      widgetPreview.src = `${baseUrl}?${previewParams}`;
    };

    // ========== Presets ==========

    const presetNameInput = document.getElementById('preset-name');
    const presetsContainer = document.getElementById('presets-container');
    let saveStateTimeout = null;

    // Get current config state
    function getCurrentConfig() {
      return {
        theme: currentTheme,
        customColors: { ...customColors },
        canvasSize: { ...canvasSize }
      };
    }

    // Apply a config state
    function applyConfig(config, skipSave = false) {
      // Apply theme
      currentTheme = config.theme || '';
      themeOptions.forEach(t => t.classList.remove('active'));

      if (currentTheme.startsWith('custom:')) {
        // Custom uploaded theme - no built-in option to highlight
        customColorSection.classList.remove('visible');
      } else {
        const matchingOption = document.querySelector(`[data-theme="${currentTheme}"]`);
        if (matchingOption) {
          matchingOption.classList.add('active');
        } else {
          themeOptions[0].classList.add('active');
        }

        if (currentTheme === 'custom') {
          customColorSection.classList.add('visible');
        } else {
          customColorSection.classList.remove('visible');
        }
      }

      // Apply custom colors
      if (config.customColors) {
        customColors = { ...config.customColors };
        bgColorInput.value = customColors.bg;
        bgColorText.value = customColors.bg;
        textColorInput.value = customColors.text;
        textColorText.value = customColors.text;
        accentColorInput.value = customColors.accent;
        accentColorText.value = customColors.accent;
        updateCustomPreview();
      }

      // Apply canvas size
      if (config.canvasSize) {
        canvasSize = { ...config.canvasSize };
        canvasWidthInput.value = canvasSize.width;
        canvasHeightInput.value = canvasSize.height;
        updateCanvasSize();
      }

      updateWidgetUrl(skipSave);
    }

    // Save current config to server (debounced)
    function autoSaveConfig() {
      if (saveStateTimeout) {
        clearTimeout(saveStateTimeout);
      }
      saveStateTimeout = setTimeout(async () => {
        try {
          await fetch('/api/widget-state', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(getCurrentConfig())
          });
        } catch (e) {
          console.error('Failed to save widget state:', e);
        }
      }, 300);
    }

    // Load last config on page load
    async function loadLastConfig() {
      try {
        const response = await fetch('/api/widget-state');
        const config = await response.json();
        applyConfig(config, true);
      } catch (e) {
        console.error('Failed to load widget state:', e);
      }
    }

    // Save current config as a preset (to server)
    async function savePreset() {
      const name = presetNameInput.value.trim();
      if (!name) {
        showNotification('Please enter a preset name', 'error');
        return;
      }

      try {
        const response = await fetch('/api/presets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            config: getCurrentConfig()
          })
        });

        const result = await response.json();

        if (result.success) {
          showNotification(result.updated ? `Preset "${name}" updated` : `Preset "${name}" saved`);
          presetNameInput.value = '';
          loadPresetsList();
        } else {
          showNotification(result.error || 'Failed to save preset', 'error');
        }
      } catch (error) {
        showNotification('Failed to save preset: ' + error.message, 'error');
      }
    }

    // Load a preset
    async function loadPreset(name) {
      try {
        const response = await fetch('/api/presets');
        const presets = await response.json();
        const preset = presets.find(p => p.name === name);

        if (preset) {
          applyConfig(preset.config);
          autoSaveConfig();
          showNotification(`Preset "${name}" loaded`);
        } else {
          showNotification('Preset not found', 'error');
        }
      } catch (error) {
        showNotification('Failed to load preset: ' + error.message, 'error');
      }
    }

    // Delete a preset
    async function deletePreset(name) {
      if (!confirm(`Delete preset "${name}"?`)) return;

      try {
        const response = await fetch(`/api/presets/${encodeURIComponent(name)}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          showNotification(`Preset "${name}" deleted`);
          loadPresetsList();
        } else {
          showNotification(result.error || 'Failed to delete preset', 'error');
        }
      } catch (error) {
        showNotification('Failed to delete preset: ' + error.message, 'error');
      }
    }

    // Render presets list (from server)
    async function loadPresetsList() {
      try {
        const response = await fetch('/api/presets');
        const presets = await response.json();

        if (presets.length === 0) {
          presetsContainer.innerHTML = '<div class="no-presets-message">No presets saved yet</div>';
          return;
        }

        presetsContainer.innerHTML = presets.map(preset => {
          const themeName = preset.config.theme.startsWith('custom:')
            ? preset.config.theme.replace('custom:', '')
            : (preset.config.theme || 'Glass');
          const size = `${preset.config.canvasSize?.width || 450}x${preset.config.canvasSize?.height || 150}`;

          return `
            <div class="preset-item">
              <div class="preset-info">
                <div class="preset-name">${preset.name}</div>
                <div class="preset-details">${themeName} Â· ${size}</div>
              </div>
              <div class="preset-actions">
                <button class="btn btn-small btn-primary" onclick="loadPreset('${preset.name.replace(/'/g, "\\'")}')">Load</button>
                <button class="btn btn-small btn-danger" onclick="deletePreset('${preset.name.replace(/'/g, "\\'")}')">Delete</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        presetsContainer.innerHTML = '<div class="no-presets-message">Error loading presets</div>';
      }
    }

    // Auto-save on any config change
    const originalUpdateWidgetUrlForAutoSave = updateWidgetUrl;
    updateWidgetUrl = function(skipSave = false) {
      originalUpdateWidgetUrlForAutoSave();
      if (!skipSave) {
        autoSaveConfig();
      }
    };

    // Start
    init();
    loadCustomThemes();
    loadPresetsList();
    loadLastConfig();
  </script>
</body>
</html>
